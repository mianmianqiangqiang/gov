(function(c){var k={400:"\u4e0d\u5408\u6cd5\u7684\u8bf7\u6c42\u6216\u88ab\u5b89\u5168\u62e6\u622a\u3002",401:"\u672a\u6388\u6743\u6216\u672a\u767b\u5f55\u3002",403:"\u5bf9\u8d44\u6e90\u6ca1\u6709\u8bbf\u95ee\u6743\u9650\u3002",404:"\u8bf7\u6c42\u7684\u8d44\u6e90\u65e0\u6cd5\u627e\u5230\u3002",500:"\u670d\u52a1\u5668\u5185\u90e8\u9519\u8bef\u3002",503:"\u670d\u52a1\u5668\u6b63\u5fd9\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002",timeout:"\u670d\u52a1\u5668\u6b63\u5fd9\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002",parsererror:"\u6570\u636e\u89e3\u6790\u5f02\u5e38\uff0c\u8fd4\u56de JSON \u683c\u5f0f\u4e0d\u5408\u6cd5\u3002"},f=function(a){var b={},d=location.search.substring(1).split("\x26");c.each(d,function(a,d){var g=d.split("\x3d"),c=g[0],g=decodeURIComponent(g[1]);"undefined"==typeof b[c]?b[c]=g:"string"==typeof b[c]?b[c]=[b[c],g]:b[c].push(g)});return a?b[a]:b},h=function(a){if(-1==location.href.indexOf("?"))return location.href;var b=location.href.split("?")[0];"string"==typeof a&&(a=[a]);var d=f();c.each(a,function(a,b){d[b]&&delete d[b]});a=c.param(d);0<a.length&&(b+="?");return b+a},e=function(a,b){return function(b){var d=b.responseJSON&&b.responseJSON.error;b=["\u8bf7\u6c42\u5730\u5740\uff1a",this.url,", \u72b6\u6001\u7801\uff1a"+(b.status||"\u8d85\u65f6"),", \u9519\u8bef\u4fe1\u606f\uff1a",d||k[b.status]].join("");a&&Util.showAjaxErr(d||b)}};window.Util||(window.Util={});c.extend(Util,{ajaxParamsHandler:function(a){if(a)return!a.params||"object"!==typeof a.params&&"string"!==typeof a.params?{params:JSON.stringify(a)}:a},ajax:function(a,b){a=c.extend({},{type:"post",dataType:"json"},a);var d=function(){},g=function(){};c.isFunction(a.success)&&(d=a.success,a.success=null,delete a.success);c.isFunction(a.error)&&(g=a.error,a.error=null,delete a.error);a.data=c.proxy(Util.ajaxParamsHandler,this)(a.data);var e,k,m,l=c.Deferred();e=OAuthInstance.isInit()?l.promise():OAuthInstance.initApp();k=OAuthInstance.anonymousToken()?l.promise():OAuthInstance.getAnonymousToken();var n=f("code");m=n?OAuthInstance.getToken(n,window.location.href):l.promise();e=e.then(function(){return m.then(function(){if(b||OAuthInstance.isLogin())return k.then(function(){var e=location.href,f=h(["code","state","timestamp"]);if(e!=f)window.location.replace(f);else{var k=!0;OAuthInstance.accessToken()&&(k=!1);a.beforeSend=b?function(a){var b=OAuthInstance.accessToken()||OAuthInstance.anonymousToken();a.setRequestHeader("Authorization","Bearer "+b)}:function(a){a.setRequestHeader("Authorization","Bearer "+OAuthInstance.accessToken())};return c.ajax(a).then(Util.ajaxPreSuccess,function(c,e,f){if(403==c.status)return a.success=d,a.error=g,(k?OAuthInstance.refreshAnonymousToken():OAuthInstance.refreshToken()).then(function(){return Util.ajax(a,b)},function(a,b,d){Util.ajaxError(a,b,d);g(a,b,d)});Util.ajaxError(c,e,f);g(c,e,f)}).done(d)}});layer?layer.open({title:"\u6e29\u99a8\u63d0\u793a",content:"\u60a8\u8fd8\u672a\u767b\u5f55\uff0c\u70b9\u51fb\u786e\u8ba4\u53bb\u767b\u5f55^_^",closeBtn:0,yes:function(a,b){OAuthInstance.goLogin();layer.close(a)}}):confirm("\u60a8\u8fd8\u672a\u767b\u5f55\uff0c\u70b9\u51fb\u786e\u8ba4\u53bb\u767b\u5f55")&&OAuthInstance.goLogin()})});l.resolve();return e},statusNodeHandler:function(a,b,d){},ajaxPreSuccess:function(a){var b=a.status,d,g;b&&(d=b.code-0,g=b.text,b=b.url,c.proxy(Util.statusNodeHandler,this)(d,g,b));return a},showAjaxErr:function(a){alert(a)},responseErrHandlers:{400:e(1),401:function(a){c.proxy(e(0,"info"),this)(a)},403:e(1),404:e(1),500:e(1),503:e(1),timeout:e(1),parsererror:function(a){},other:function(a,b,d){}},ajaxError:function(a,b,d){var g=function(){},g="timeout"===b||"parsererror"===b?Util.responseErrHandlers[b]:-1<c.inArray(a.status,[400,401,403,404,500,503])?Util.responseErrHandlers[a.status]:Util.responseErrHandlers.other;c.proxy(g,this)(a,b,d)}})})($);(function(c,k){var f={expires:7};if(window.Cookies&&!c.OAuth){var h={basepath:siteInfo.projectName,action:{getappinfo:"/rest/getOauthInfoAction/getAppInfo",gettoken:"/rest/getOauthInfoAction/getAccessToken",gettokenbypwd:"/rest/getOauthInfoAction/getAccessTokenByPwd",getanonymoustoken:"/rest/getOauthInfoAction/getNoUserAccessToken",refreshtoken:"/rest/getOauthInfoAction/refreshAccessToken"},isNeedTip:!0,showErrorMsg:function(a){}},e=function(a){a=k.extend({},{type:"post",dataType:"json",cache:!1},a);var b=function(){};k.isFunction(a.success)&&(b=a.success,a.success=null,delete a.success);k.isFunction(a.error)&&(error=a.error,a.error=null,delete a.error);a.data={params:JSON.stringify(a.data)};return k.ajax(a).done(function(a){var b=a.status;a=a.custom;b&&0==b.code&&b.text&&h.showErrorMsg(b.text);a&&a.errorText&&h.showErrorMsg(a.errorText)}).fail(function(a,b,c){["\u8bf7\u6c42\u5730\u5740\uff1a",this.url,", \u72b6\u6001\u7801\uff1a"+(a.status||"\u8d85\u65f6"),", \u9519\u8bef\u4fe1\u606f\uff1a",a.responseJSON&&a.responseJSON.error].join("");error(a,b,c)}).done(b)};c.OAuth=function(a){k.extend(h,a);Cookies.get("oauthLoginUrl")&&(this.oauthLoginUrl=Cookies.get("oauthLoginUrl")+location.href,this.oauthLogoutUrl=Cookies.get("oauthLogoutUrl")+"http://"+location.host)};k.extend(OAuth.prototype,{isInit:function(){return Cookies.get("oauthClientId")?!0:!1},isLogin:function(){return Cookies.get("oauthAccessToken")?!0:!1},goLogin:function(){window.location.replace(this.oauthLoginUrl)},accessToken:function(){return Cookies.get("oauthAccessToken")},anonymousToken:function(){return Cookies.get("noOauthAccessToken")},initApp:function(){var a=this;a.initAppXhr||(a.initAppXhr=e({url:h.basepath+h.action.getappinfo}).done(function(b){if(b=b.custom)Cookies.set("oauthClientId",b.client_id,f),Cookies.set("oauthPath",b.ssoPath,f),Cookies.set("oauthLoginUrl",b.oauthLoginUrl,f),Cookies.set("oauthLogoutUrl",b.oauthLogoutUrl,f),a.oauthLoginUrl=Cookies.get("oauthLoginUrl")+location.href,a.oauthLogoutUrl=Cookies.get("oauthLogoutUrl")+"http://"+location.host}).always(function(){a.initAppXhr=null}));return a.initAppXhr},refreshToken:function(){var a=this;a.refreshTokenXhr||(a.refreshTokenXhr=e({url:h.basepath+h.action.refreshtoken,data:{refresh_token:Cookies.get("oauthRefreshToken")}}).then(function(b){b=b.custom;b.errorText&&-1<b.errorText.indexOf("expired_refreshtoken")?(a.clearToken(),OAuthInstance.goLogin()):(Cookies.set("oauthRefreshToken",b.refresh_token,f),Cookies.set("oauthAccessToken",b.access_token,f))},function(){OAuthInstance.goLogin()}).always(function(){a.refreshTokenXhr=null}));return a.refreshTokenXhr},refreshAnonymousToken:function(){var a=this;a.refreshAnonymousTokenXhr||(a.refreshAnonymousTokenXhr=e({url:h.basepath+h.action.refreshtoken,data:{refresh_token:Cookies.get("noOauthRefreshToken")}}).then(function(b){b=b.custom;if(b.errorText&&-1<b.errorText.indexOf("expired_refreshtoken"))return a.getAnonymousToken();Cookies.set("noOauthRefreshToken",b.refresh_token,f);Cookies.set("noOauthAccessToken",b.access_token,f)},function(){return a.getAnonymousToken()}).always(function(){a.refreshAnonymousTokenXhr=null}));return a.refreshAnonymousTokenXhr},getToken:function(a,b){var d=this;d.gettokenXhr||(d.gettokenXhr=e({url:h.basepath+h.action.gettoken,data:{code:a,redirect_url:b}}).done(function(a){a=a.custom;a.errorText?alert("\u7cfb\u7edf\u9519\u8bef\uff0c\u8bf7\u8054\u7cfb\u7ba1\u7406\u5458\uff01"):(Cookies.set("oauthRefreshToken",a.refresh_token,f),Cookies.set("oauthAccessToken",a.access_token,f))}).always(function(){d.gettokenXhr=null}));return d.gettokenXhr},getAnonymousToken:function(){var a=this;a.getAnonymousTokenXhr||(a.getAnonymousTokenXhr=e({url:h.basepath+h.action.getanonymoustoken}).done(function(a){if(a=a.custom)Cookies.set("noOauthRefreshToken",a.refresh_token,f),Cookies.set("noOauthAccessToken",a.access_token,f)}).always(function(){a.getAnonymousTokenXhr=null}));return a.getAnonymousTokenXhr},getAccessTokenByPwd:function(a,b){return e({url:h.basepath+h.action.gettokenbypwd,data:{username:a,password:b},async:!1,success:function(a){a=a.custom;a.errorText?alert(a.errorText):(Cookies.set("oauthRefreshToken",a.refresh_token,f),Cookies.set("oauthAccessToken",a.access_token,f))}})},ssoLogin:function(a,b){var c={isCommondto:!0,username:a,password:b};k.ajax({url:Cookies.get("oauthPath")+"/rest/oauth2/remotelogin",data:c,dataType:"json",xhrFields:{withCredentials:!0},cache:!1}).done(function(a){}).fail(function(a){})},logout:function(){Cookies.remove("oauthAccessToken");Cookies.remove("oauthRefreshToken");window.location.replace(this.oauthLogoutUrl)},clearToken:function(){Cookies.remove("oauthRefreshToken");Cookies.remove("oauthAccessToken")}});c.OAuthInstance=new OAuth}})(this,jQuery);